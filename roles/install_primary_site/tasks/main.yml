---
- name: Check that defined hostnames are <= 15 characters
  ansible.builtin.fail:
    msg: "{{ sccm_vm_hostname }} is longer than 15 characters. Due to requirements of SCCM this is not allowed."
  when: 
    - sccm_vm_hostname is defined
    - sccm_vm_hostname != ""
    - sccm_vm_hostname | length > 15
  loop:
    - "{{ ludus_sccm_site_server_hostname | default('') }}"
    - "{{ ludus_sccm_distro_server_hostname | default('') }}"
    - "{{ ludus_sccm_mgmt_server_hostname | default('') }}"
    - "{{ ludus_sccm_sql_server_hostname | default('') }}"
  loop_control:
    loop_var: sccm_vm_hostname

- name: Create System Management Container and Configure Permissions
  ansible.windows.win_shell: |
   C:\ludus\sccm\SystemManagement.ps1
  vars:
    ansible_become: true
    ansible_become_method: runas
    ansible_become_user: '{{ ludus_domain_fqdn }}\{{ defaults.ad_domain_admin }}'
    ansible_become_password: '{{ defaults.ad_domain_admin_password }}'
    ansible_become_flags: "logon_type=interactive logon_flags=with_profile"

- name: Extend Schema
  ansible.windows.win_shell: |
   C:\ludus\sccm\cd.retail.LN\SMSSETUP\BIN\X64\extadsch.exe
  vars:
    ansible_become: true
    ansible_become_method: runas
    ansible_become_user: '{{ ludus_domain_fqdn }}\{{ defaults.ad_domain_admin }}'
    ansible_become_password: '{{ defaults.ad_domain_admin_password }}'
    ansible_become_flags: "logon_type=interactive logon_flags=with_profile"

# Start SCCM Install-------------------------------------------------------------------
- name: Check if SCCM is already installed
  ansible.windows.win_service_info:
    name: SMS_EXECUTIVE
  register: sccm_service

- name: Skip installation if SCCM is already installed
  debug:
    msg: "SMS_EXECUTIVE service is running - SCCM already installed, skipping installation"
  when: 
    - sccm_service.services | default([]) | length > 0
    - sccm_service.services[0].state in ['running', 'started']

- name: Set skip flag when SCCM service is running
  set_fact:
    skip_installation: true
  when:
    - sccm_service.services | default([]) | length > 0
    - sccm_service.services[0].state in ['running', 'started']

- name: Reboot the site server before installation to ensure clean state (avoid 'Failed to create process of SetupWpf.exe' errors)
  ansible.windows.win_reboot:
    reboot_timeout: 600
    #post_reboot_delay: 30
  when: not (skip_installation | default(false))

- name: Initialize attempt counter
  set_fact:
    sccm_attempt_number: 1
  when: not (skip_installation | default(false))

- name: Run SCCM installation with retry on stall
  when: not (skip_installation | default(false))
  block:
    - name: First installation attempt
      include_tasks: install_sccm.yml
      vars:
        attempt_number: 1
      
  rescue:
    - name: First stall detected - rebooting site server and retrying
      debug:
        msg: "Installation stalled on attempt 1 - rebooting site server"

    - name: Reboot site server
      ansible.windows.win_reboot:
        reboot_timeout: 600
        #post_reboot_delay: 30

    - name: Update attempt counter for retry
      set_fact:
        sccm_attempt_number: 2

    - name: Second installation attempt
      block:
        - name: Retry installation after reboot
          include_tasks: install_sccm.yml
          vars:
            attempt_number: 2
      
      rescue:
        - name: Second stall detected - rebooting site server and site database server and retrying
          debug:
            msg: "Installation stalled on attempt 2 - rebooting site server and site database server"

        - name: Reboot site server
          ansible.windows.win_reboot:
            reboot_timeout: 600
            #post_reboot_delay: 30

        - name: Reboot site database server
          ansible.windows.win_shell: |
            Restart-Computer -ComputerName "{{ ludus_sccm_sql_server_hostname }}.{{ ludus_domain_fqdn }}" -Force
          when: ludus_sccm_sql_server_hostname != inventory_hostname
          vars:
            ansible_become: true
            ansible_become_method: runas
            ansible_become_user: '{{ ludus_domain_fqdn }}\{{ defaults.ad_domain_admin }}'
            ansible_become_password: '{{ defaults.ad_domain_admin_password }}'
            ansible_become_flags: "logon_type=interactive logon_flags=with_profile"

        - name: Update attempt counter for final retry
          set_fact:
            sccm_attempt_number: 3

        - name: Third installation attempt
          block:
            - name: Final retry installation after reboot
              include_tasks: install_sccm.yml
              vars:
                attempt_number: 3
          
          rescue:
            - name: Third attempt failed - giving up
              fail:
                msg: "SCCM installation stalled three times - failing playbook"

- name: Cleanup tracker file
  ansible.windows.win_file:
    path: C:\sccm_stall_tracker.txt
    state: absent
  when: not (skip_installation | default(false))
  
# Start CM Account Configuration-------------------------------------------------------
- name: Begin CM Account Configuration
  ansible.builtin.include_tasks:
    file: cm_accounts.yml

# Start NAA Configuration--------------------------------------------------------------
- name: Begin NAA Configuration
  ansible.builtin.include_tasks:
    file: config_naa.yml
  when: ludus_sccm_configure_naa == true

# Configure Push Account---------------------------------------------------------------
- name: Configure Push Client Installation
  ansible.builtin.include_tasks:
    file: client_push.yml
  when: ludus_sccm_configure_client_push == true

# Configure Discovery Methods----------------------------------------------------------
- name: Configure Discovery Methods
  ansible.builtin.include_tasks:
    file: discovery_methods.yml

# Configure PXE------------------------------------------------------------------------
- name: Configure PXE
  ansible.builtin.include_tasks:
    file: config_pxe.yaml
  when: ludus_sccm_enable_pxe == true
