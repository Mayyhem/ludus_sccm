---
# This prevents waiting hours for SCCM setup to fail if the MSSQL server is not up
- name: Set effective SQL server hostname (use 127.0.0.1 if local)
  ansible.windows.win_shell: |
    $sqlHost = "{{ ludus_sccm_sql_server_hostname }}"
    $localHost = $env:COMPUTERNAME
    if ($sqlHost -ieq $localHost) { "127.0.0.1" } else { $sqlHost }
  register: effective_sql_server_hostname_result
  changed_when: false

- name: Set fact for effective SQL server hostname
  set_fact:
    effective_sql_server_hostname: "{{ effective_sql_server_hostname_result.stdout | trim }}"

- name: Probe SQL TCP port
  ansible.windows.win_shell: |
    $result = Test-NetConnection -ComputerName "{{ effective_sql_server_hostname }}" -Port 1433 -InformationLevel Detailed
    if ($result.TcpTestSucceeded) { Write-Output "open"; exit 0 } else { Write-Output "closed"; exit 1 }
  register: sql_probe
  changed_when: false
  failed_when: false

- name: Decide on proceeding based on SQL reachability
  block:
    - name: Fail when SQL is unreachable
      ansible.builtin.fail:
        msg: "SQL server {{ effective_sql_server_hostname }} port 1433 not reachable"
      when: sql_probe.stdout | default('closed') | trim != 'open'

- name: Update attempt counter
  set_fact:
    sccm_attempt_number: "{{ attempt_number }}"

- name: Save previous logs and trackers (attempt {{ attempt_number }})
  ansible.windows.win_shell: |
    $logDir = "C:\sccm_logs_archive"
    if (-not (Test-Path $logDir)) {
      New-Item -Path $logDir -ItemType Directory -Force | Out-Null
    }
    
    if (Test-Path "C:\ConfigMgrSetup.log") {
      Move-Item "C:\ConfigMgrSetup.log" "$logDir\ConfigMgrSetup_attempt_{{ attempt_number }}.log" -Force -ErrorAction SilentlyContinue
    }
    if (Test-Path "C:\ConfigMgrPrereq.log") {
      Move-Item "C:\ConfigMgrPrereq.log" "$logDir\ConfigMgrPrereq_attempt_{{ attempt_number }}.log" -Force -ErrorAction SilentlyContinue
    }
    if (Test-Path "C:\sccm_stall_tracker.txt") {
      Move-Item "C:\sccm_stall_tracker.txt" "$logDir\sccm_stall_tracker_attempt_{{ attempt_number }}.txt" -Force -ErrorAction SilentlyContinue
    }
  failed_when: false
  changed_when: false
  vars:
    ansible_become: true
    ansible_become_method: runas
    ansible_become_user: '{{ ludus_domain_fqdn }}\{{ defaults.ad_domain_admin }}'
    ansible_become_password: '{{ defaults.ad_domain_admin_password }}'
    ansible_become_flags: "logon_type=interactive logon_flags=with_profile"

- name: Create monitor script (attempt {{ attempt_number }})
  ansible.windows.win_copy:
    dest: C:\sccm_monitor.ps1
    force: yes
    content: |
      try {
      # Paths used by checks
      $setupLog = "C:\ConfigMgrSetup.log"
      $prereqLog = "C:\ConfigMgrPrereq.log"
      $tracker = "C:\sccm_stall_tracker.txt"

      # Completion criteria:
      # 1) SMS_EXECUTIVE service running
      # 2) 'Completed Configuration Manager Server Setup' present in ConfigMgrSetup.log
      # 3) Configuration Manager Console installed
      $service = Get-Service -Name "SMS_EXECUTIVE" -ErrorAction SilentlyContinue
      $smsRunning = $service -and $service.Status -eq "Running"

      $logHasCompleted = $false
      if (Test-Path $setupLog) {
        try {
          $logHasCompleted = Select-String -Path $setupLog -SimpleMatch "Completed Configuration Manager Server Setup" -Quiet -ErrorAction Stop
        } catch { $logHasCompleted = $false }
      }

      $consoleInstalled = $false
      try {
        $uninstallPaths = @(
          "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*",
          "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*"
        )
        $consoleInstalled = [bool](Get-ItemProperty -Path $uninstallPaths -ErrorAction SilentlyContinue |
          Where-Object { $_.DisplayName -match "Configuration Manager Console" -or $_.DisplayName -match "Endpoint Configuration Manager Console" -or $_.DisplayName -match "System Center Configuration Manager Console" } |
          Select-Object -First 1)
        if (-not $consoleInstalled) {
          # Fallback: check known console binary path
          $consoleInstalled = Test-Path "C:\Program Files (x86)\Microsoft Configuration Manager\AdminConsole\bin\Microsoft.ConfigurationManagement.exe"
        }
      } catch { $consoleInstalled = $false }

      if ($smsRunning -and $logHasCompleted -and $consoleInstalled) {
        Write-Output "Installation complete: service running, setup log complete, console installed."
        $host.SetShouldExit(0)
        exit 0
      }
          
          $setupLogExists = Test-Path $setupLog
          $prereqLogExists = Test-Path $prereqLog
          
          # Check if setup process is running
          $setupProcess = Get-Process -Name "setupwpf" -ErrorAction SilentlyContinue | Where-Object { $_.Path -like "*SMSSETUP*" }
          
          if (-not $setupProcess) {
              # Setup process not running - check if it ever started
              if ($setupLogExists -or $prereqLogExists) {
                  Write-Output "Setup process has exited - installation failed"
                  
                  # Check for duplicate installation error
                  if ($prereqLogExists) {
                      try {
                          $prereqContent = Get-Content $prereqLog -Raw -ErrorAction Stop
                          if ($prereqContent -match "ERROR: Site server has already been installed on this machine") {
                              Write-Output "DUPLICATE INSTALLATION DETECTED - Running deinstall"
                              Start-Process -FilePath "C:\ludus\sccm\cd.retail.LN\SMSSETUP\BIN\X64\setup.exe" -ArgumentList "/DEINSTALL" -NoNewWindow -Wait
                              Write-Output "Deinstall completed"
                          }
                      } catch {
                          Write-Output "Could not read prereq log"
                      }
                  }
                  
                  Write-Output "`n=== Last 50 lines of ConfigMgrSetup.log ==="
                  if ($setupLogExists) {
                      try {
                          Get-Content $setupLog -Tail 50 -ErrorAction Stop | ForEach-Object { Write-Output $_ }
                      } catch {}
                  }
                  if ($prereqLogExists) {
                      Write-Output "`n=== Last 50 lines of ConfigMgrPrereq.log ==="
                      try {
                          Get-Content $prereqLog -Tail 50 -ErrorAction Stop | ForEach-Object { Write-Output $_ }
                      } catch {}
                  }
                  $host.SetShouldExit(1)
                  exit 1
              } else {
                  Write-Output "Setup process not running - waiting for setup to start"
                  $host.SetShouldExit(2)
                  exit 2
              }
          }
          
          Write-Output "Setup running (PID: $($setupProcess.Id)) - monitoring for stalls"
          
          $currentSizes = @{}
          $mostRecentLog = $null
          $mostRecentTime = [DateTime]::MinValue
          
          foreach ($log in @($setupLog, $prereqLog)) {
              if (Test-Path $log) {
                  try {
                      $file = Get-Item $log -ErrorAction Stop
                      $currentSizes[$log] = $file.Length
                      if ($file.LastWriteTime -gt $mostRecentTime) {
                          $mostRecentTime = $file.LastWriteTime
                          $mostRecentLog = $log
                      }
                  } catch {
                      $currentSizes[$log] = 0
                  }
              } else {
                  $currentSizes[$log] = 0
              }
          }
          
          # Load previous state
          $previousSizes = @{}
          $stallCount = 0
          
          if (Test-Path $tracker) {
              try {
                  $data = Get-Content $tracker -ErrorAction Stop
                  if ($data -and $data.Count -ge 3) {
                      $previousSizes[$setupLog] = [long]$data[0]
                      $previousSizes[$prereqLog] = [long]$data[1]
                      $stallCount = [int]$data[2]
                  }
              } catch {
                  # Ignore tracker read errors
              }
          }
          
          # Check if either log has grown
          $hasGrowth = $false
          foreach ($log in $currentSizes.Keys) {
              $prev = if ($previousSizes.ContainsKey($log)) { $previousSizes[$log] } else { -1 }
              $curr = $currentSizes[$log]
              
              if ($prev -ne -1 -and $curr -gt $prev) {
                  $hasGrowth = $true
                  Write-Output "$log grew by $($curr - $prev) bytes"
              }
          }
          
          if (-not $hasGrowth -and $previousSizes.Count -gt 0) {
              $stallCount++
              $stallSeconds = $stallCount * 60 # Each check is 1 minute apart
              Write-Output "No log growth - stalled for $stallSeconds seconds ($stallCount/10 checks)"
              
              # If stalled for 10 checks (10 minutes), consider it a stall
              if ($stallCount -ge 10) {
                  Write-Output "STALL DETECTED after 10 minutes"
                  
                  # Check for duplicate installation error
                  if (Test-Path $prereqLog) {
                      try {
                          $prereqContent = Get-Content $prereqLog -Raw -ErrorAction Stop
                          if ($prereqContent -match "ERROR: Site server has already been installed on this machine") {
                              Write-Output "DUPLICATE INSTALLATION DETECTED - Running deinstall"
                              Stop-Process -Id $setupProcess.Id -Force
                              Start-Sleep -Seconds 2
                              Start-Process -FilePath "C:\ludus\sccm\cd.retail.LN\SMSSETUP\BIN\X64\setup.exe" -ArgumentList "/DEINSTALL" -NoNewWindow -Wait
                              Write-Output "Deinstall completed"
                          } else {
                              Write-Output "Terminating stalled setup process"
                              Stop-Process -Id $setupProcess.Id -Force
                          }
                      } catch {
                          Write-Output "Terminating stalled setup process"
                          Stop-Process -Id $setupProcess.Id -Force
                      }
                  }
                  
                  Write-Output "`n=== Last 50 lines of $mostRecentLog ==="
                  if (Test-Path $mostRecentLog) {
                      try {
                          Get-Content $mostRecentLog -Tail 50 -ErrorAction Stop | ForEach-Object { Write-Output $_ }
                      } catch {}
                  }
                  $host.SetShouldExit(1)
                  exit 1
              }
          } else {
              $stallCount = 0
          }
          
          # Save current state
          try {
              "$($currentSizes[$setupLog])`n$($currentSizes[$prereqLog])`n$stallCount" | Out-File -FilePath $tracker -Force -ErrorAction Stop
          } catch {
              # Silently ignore tracker write failures
          }
          
          Write-Output "Setup in progress - continuing to monitor"
          $host.SetShouldExit(2)
          exit 2
      } catch {
          Write-Output "CRITICAL ERROR in monitor script: $_"
          $host.SetShouldExit(2)
          exit 2
      }
  vars:
    ansible_become: true
    ansible_become_method: runas
    ansible_become_user: '{{ ludus_domain_fqdn }}\{{ defaults.ad_domain_admin }}'
    ansible_become_password: '{{ defaults.ad_domain_admin_password }}'
    ansible_become_flags: "logon_type=interactive logon_flags=with_profile"

- name: Ensure scheduled task exists for SCCM install (attempt {{ attempt_number }})
  ansible.windows.win_shell: |
    schtasks.exe /Create /TN 'SCCM-Setup-Install' /TR 'C:\ludus\sccm\cd.retail.LN\SMSSETUP\BIN\X64\setupwpf.exe /SCRIPT C:\ludus\sccm\ConfigMgrSetup.ini' /SC ONCE /ST 00:00 /RL HIGHEST /RU '{{ ludus_domain_fqdn }}\{{ defaults.ad_domain_admin }}' /RP '{{ defaults.ad_domain_admin_password }}' /F
  changed_when: true

- name: Start SCCM install scheduled task (attempt {{ attempt_number }})
  ansible.windows.win_shell: |
    schtasks /Run /TN "SCCM-Setup-Install"
  register: setup_job_start
  changed_when: true
  failed_when: false

- name: Wait for setup to actually start
  ansible.windows.win_shell: |
    $process = Get-Process -Name "setupwpf" -ErrorAction SilentlyContinue | Where-Object { $_.Path -like "*SMSSETUP*" }
    if ($process) {
      Write-Output "Setup process started with PID: $($process.Id)"
      exit 0
    }
    exit 1
  register: setup_start_check
  until: setup_start_check.rc == 0
  retries: 10
  delay: 5
  failed_when: false
  vars:
    ansible_become: true
    ansible_become_method: runas
    ansible_become_user: '{{ ludus_domain_fqdn }}\{{ defaults.ad_domain_admin }}'
    ansible_become_password: '{{ defaults.ad_domain_admin_password }}'
    ansible_become_flags: "logon_type=interactive logon_flags=with_profile"

- name: Check if setup started successfully
  fail:
    msg: "Setup process failed to start after 50 seconds"
  when: setup_start_check.rc != 0

- name: Monitor setup process (attempt {{ attempt_number }})
  ansible.windows.win_shell: C:\sccm_monitor.ps1
  register: monitor_result
  until: monitor_result.rc == 0 or monitor_result.rc == 1
  retries: 120 # Check for up to 2 hours
  delay: 60 # Check every minute
  failed_when: monitor_result.rc == 1
  vars:
    ansible_become: true
    ansible_become_method: runas
    ansible_become_user: '{{ ludus_domain_fqdn }}\{{ defaults.ad_domain_admin }}'
    ansible_become_password: '{{ defaults.ad_domain_admin_password }}'
    ansible_become_flags: "logon_type=interactive logon_flags=with_profile"

- name: Verify SMS_EXECUTIVE is running (attempt {{ attempt_number }})
  ansible.windows.win_service_info:
    name: SMS_EXECUTIVE
  register: final_check
  failed_when: 
    - final_check.services | length == 0 or final_check.services[0].state != "started"
  vars:
    ansible_become: true
    ansible_become_method: runas
    ansible_become_user: '{{ ludus_domain_fqdn }}\{{ defaults.ad_domain_admin }}'
    ansible_become_password: '{{ defaults.ad_domain_admin_password }}'
    ansible_become_flags: "logon_type=interactive logon_flags=with_profile"

- name: Verify setup log indicates completion (attempt {{ attempt_number }})
  ansible.windows.win_shell: |
    $log = "C:\ConfigMgrSetup.log"
    if (Test-Path $log) {
      if (Select-String -Path $log -SimpleMatch "Completed Configuration Manager Server Setup" -Quiet) { exit 0 }
    }
    Write-Output "Completion string not found in ConfigMgrSetup.log"
    exit 1
  register: setup_log_check
  failed_when: setup_log_check.rc != 0
  vars:
    ansible_become: true
    ansible_become_method: runas
    ansible_become_user: '{{ ludus_domain_fqdn }}\{{ defaults.ad_domain_admin }}'
    ansible_become_password: '{{ defaults.ad_domain_admin_password }}'
    ansible_become_flags: "logon_type=interactive logon_flags=with_profile"

- name: Verify Configuration Manager Console is installed (attempt {{ attempt_number }})
  ansible.windows.win_shell: |
    $uninstallPaths = @(
      "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*",
      "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*"
    )
    $console = Get-ItemProperty -Path $uninstallPaths -ErrorAction SilentlyContinue |
      Where-Object { $_.DisplayName -match "Configuration Manager Console" -or $_.DisplayName -match "Endpoint Configuration Manager Console" -or $_.DisplayName -match "System Center Configuration Manager Console" } |
      Select-Object -First 1
    if ($console) { exit 0 }
    if (Test-Path "C:\Program Files (x86)\Microsoft Configuration Manager\AdminConsole\bin\Microsoft.ConfigurationManagement.exe") { exit 0 }
    Write-Output "Configuration Manager Console not found"
    exit 1
  register: console_check
  failed_when: console_check.rc != 0
  vars:
    ansible_become: true
    ansible_become_method: runas
    ansible_become_user: '{{ ludus_domain_fqdn }}\{{ defaults.ad_domain_admin }}'
    ansible_become_password: '{{ defaults.ad_domain_admin_password }}'
    ansible_become_flags: "logon_type=interactive logon_flags=with_profile"